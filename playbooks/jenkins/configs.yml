---
- name: Handle configs for an instance
  hosts: dockerhost
  sudo: False

  vars:
    - base_folder: ../..
    - do_debug: False

  vars_files:
    - "{{ base_folder }}/roles/vars/base.yml"
    - "{{ base_folder }}/vars/group/{{ image }}.vault"

  pre_tasks:
    - include: '{{ tasks_base }}debug_info.yml'
      when: do_debug == True
    - debug: msg="{{ lookup('pipe', 'ls -la ../../configs/.secrets/vpf.txt') }} is the raw result of running this command"
      when: do_debug == True

    - include: '{{ tasks_base }}check_connection.yml'

    - include: '{{ tasks_base }}check_folders.yml'
      when: do_debug == True

  tasks:
    - name: Create folders in "{{ volume_home }}/users/" for default user configs
      file: dest="{{ volume_home }}/users/{{ item | dirname | basename }}/" state=directory mode=0775
      #debug: vars="{{ item }}" msg="{{ volume_home }}/users/{{ item | dirname | basename }}/"
      register: checkout
      failed_when: checkout.state != "directory"
      with_fileglob:
        - "{{ files_base }}{{ image }}//jenkins/users/**/*.j2"

    - name: Create folders in "{{ volume_home }}/jobs/" for default job configs
      file: dest="{{ item | dirname | replace(files_base + image + "/jenkins", jenkins_base + "/" + env_name) }}/" state=directory mode=0775
      #debug: vars="{{ item }}" msg="{{ item | dirname | replace(files_base + image + "/jenkins", jenkins_base + "/" + env_name) }}/"
      register: checkout
      failed_when: checkout.state != "directory"
      with_fileglob:
        - "{{ files_base }}{{ image }}/jenkins/jobs/**/*.j2"
        - "{{ files_base }}{{ image }}/jenkins/jobs/**/jobs/**/*.j2"

    - name: Process template for configs
      template: src="{{ item }}" dest="{{ volume_home }}/{{ item | basename | regex_replace('^(.*)\.j2$', '\\1') }}"
      with_fileglob:
        - "{{ files_base }}{{ image }}/jenkins/*.j2"

    - name: Process templates for default user configs
      template: src="{{ item }}" dest="{{ volume_home }}/users/{{ item | dirname | basename }}/{{ item | basename | regex_replace('^(.*)\.j2$', '\\1') }}"
      #debug: vars="{{ item }}" msg="{{ volume_home }}/users/{{ item | dirname | basename }}/{{ item | basename | regex_replace('^(.*)\.j2$', '\\1') }}"
      with_fileglob:
        - "{{ files_base }}{{ image }}/jenkins/users/**/*.j2"

    - name: Process templates for default job configs
      template: src="{{ item }}" dest="{{ item | dirname | replace(files_base + image + "/jenkins", jenkins_base + "/" + env_name) }}/{{ item | basename | regex_replace('^(.*)\.j2$', '\\1') }}"
      #debug: vars="{{ item }}" msg="{{ item | dirname | replace(files_base + image + "/jenkins", jenkins_base + "/" + env_name) }}/{{ item | basename | regex_replace('^(.*)\.j2$', '\\1') }}"
      with_fileglob:
        - "{{ files_base }}{{ image }}/jenkins/jobs/**/*.j2"
        - "{{ files_base }}{{ image }}/jenkins/jobs/**/jobs/**/*.j2"

    - name: Copy credentials file
      copy: content="{{ lookup('pipe', 'ansible-vault view --vault-password-file=' + base_folder + '/configs/.secrets/vpf.txt ' + files_base + image + '/jenkins/credentials.xml') }}" dest="{{ volume_home }}/credentials.xml"
